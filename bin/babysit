#!/usr/bin/env bash

base_url="localhost:8888/api/babysitter/signal"

key="$1"
if [ -z "$key" ]; then
  key="UNKNOWN"
fi
random_value="$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1)"

# TODO: report failures

args=( "${@:2}" )
args_str="$(printf "'%s' " "${args[@]}")"

printf "> Babysitting...\n\n"
curl -X POST \
  -F "type=start" \
  -F "key=${key}" \
  -F "id=${random_value}" \
  -F "cmd=${args_str}" \
  -F "cwd=$(pwd)" \
  "${base_url}" > /dev/null 2>&1

# Run all args except the first as if they were a command.
"${@:2}"

printf "\n> Babysat.\n"
curl -X POST \
  -F "type=end" \
  -F "key=${key}" \
  -F "id=${random_value}" \
  "${base_url}" > /dev/null 2>&1

