#!/usr/bin/env bash

base_url="https://localhost:8888/api/babysitter/signal"
script_dir="$(cd "$(dirname "$0")" && pwd)"
certfile="${script_dir}/../ssl/generated/Certificate.crt"
keyfile="${script_dir}/../ssl/generated/Key.key"

while [ "$#" -gt "0" ]; do
  case "$1" in
    "--key")
      key="$2"
      shift 2
      ;;
    *)
      break ;;
  esac
done

if [ -z "$key" ]; then
  key="$*"
fi

random_value="$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1)"

args=( "$@" )
args_str="$(printf "'%s' " "${args[@]}")"

printf "> Command: %s\n" "${args[*]}"
printf "> Babysitting...\n\n"
curl -X POST \
  --cert "${certfile}" \
  --key "${keyfile}" \
  -k \
  -F "type=start" \
  -F "key=${key}" \
  -F "id=${random_value}" \
  -F "cmd=${args_str}" \
  -F "cwd=$(pwd)" \
  "${base_url}" > /dev/null 2>&1

# Run all remaining args as a command
"$@"

if [ "$?" -ne "0" ]; then
  action="failure"
else
  action="success"
fi

printf "\n> Babysat.\n"
curl -X POST \
  --cert "${certfile}" \
  --key "${keyfile}" \
  -k \
  -F "type=${action}" \
  -F "key=${key}" \
  -F "id=${random_value}" \
  "${base_url}" > /dev/null 2>&1

